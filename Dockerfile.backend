# ---------- 1. Build stage ----------
FROM node:20-alpine AS builder

WORKDIR /app

# Install Node dependencies for build
COPY package*.json ./
RUN npm install

# Copy TypeScript source
COPY tsconfig.json ./tsconfig.json
COPY src ./src

# Build TypeScript -> dist
RUN npm run build


# ---------- 2. Runtime stage ----------
# Use Playwright's official Python image so browsers and required OS deps are present.
FROM mcr.microsoft.com/playwright/python:latest AS runner

# Install minimal utilities + Node 20 so we can run the built Node app in this image.
# (Playwright image already includes Python and browsers.)
RUN apt-get update \
 && apt-get install -y --no-install-recommends ca-certificates curl gnupg \
 && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
 && apt-get install -y --no-install-recommends nodejs \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files and install production Node deps
COPY package*.json ./
RUN npm install --omit=dev

# Copy built JS from builder
COPY --from=builder /app/dist ./dist

# Copy repo Python extractor (if present) and the docker/ folder (loops + start script)
COPY extract_document_urls.py ./extract_document_urls.py
COPY parse_supabase_bids.py ./parse_supabase_bids.py
COPY docker/ /app/docker/

# Make the docker scripts executable (including start.sh and your loop scripts)
RUN chmod +x /app/docker/*.sh || true \
 && chmod +x /app/docker/start.sh || true

# Install Python packages needed by extract_document_urls.py / parser (playwright already present)
RUN pip3 install --no-cache-dir PyPDF2 supabase python-dotenv openai

# Environment / port
ENV NODE_ENV=production

EXPOSE 10000

# Use the orchestrator startup script which launches node + loops and tails logs
# (start.sh must exist at docker/start.sh in your repo)
CMD ["/app/docker/start.sh"]
